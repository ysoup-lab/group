<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å‚…å“¥ - æ‹¼å›¢é¡¹ç›® - å•†å“è¯¦æƒ…é¡µ</title>
    <link rel="stylesheet" href="css/index.css">

</head>
<body>
<!-- è½®æ’­å›¾ -->
<div class="swiper-container">
    <div class="swiper-wrapper">
        <div class="swiper-slide"><img src="./images/sku-13811216-01.png"></div>
        <div class="swiper-slide"><img src="./images/sku-13811216-02.png"></div>
        <div class="swiper-slide"><img src="./images/sku-13811216-03.png"></div>
    </div>
    <div class="swiper-pagination"></div>
</div>

<!-- å•†å“ä¿¡æ¯ -->
<div class="product-info">
    <h1 class="product-title">æ‰‹å†™MyBatisï¼šæ¸è¿›å¼æºç å®è·µï¼ˆå…¨å½©ï¼‰</h1>
    <span class="promotion-tag">å¤§ä¿ƒä¼˜æƒ </span>
    <span class="promotion-text"></span> <!-- åŠ¨æ€å¡«å……ä¿ƒé”€æ–‡æœ¬ -->
</div>

<!-- æ‹¼å•åˆ—è¡¨å®¹å™¨ -->
<div class="group-list">
    <!-- åŠ¨æ€ç”Ÿæˆæ‹¼å›¢åˆ—è¡¨ -->
</div>

<!-- ç©ºç™½åŒºåŸŸ -->
<div class="area"></div>

<!-- åº•éƒ¨æ“ä½œæ  -->
<div class="action-bar">
    <button class="action-btn buy-alone"></button>
    <button class="action-btn group-buy"></button>
</div>

<script src="js/index.js"></script>
<script>
// æ–°å¢æ”¯ä»˜ç¡®è®¤å‡½æ•°
function showPaymentConfirm(price) {
    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.className = 'payment-overlay';

    // åˆ›å»ºå¼¹çª—å†…å®¹
    const modal = document.createElement('div');
    modal.className = 'payment-modal';
    modal.innerHTML = `
        <h3>æ”¯ä»˜ç¡®è®¤</h3>
        <p>å•†å“é‡‘é¢ï¼šï¿¥${price}</p>
        <p>ä¹°å®¶è´¦å·ï¼š<span class="copyable" data-copy="kvhmoj3832@sandbox.com">kvhmoj3832@sandbox.com</span></p>
        <p>ç™»å½•å¯†ç ï¼š111111</p>
        <p>æ”¯ä»˜å¯†ç ï¼š111111</p>
        <div class="modal-buttons">
            <button class="confirm-btn">ç¡®è®¤æ”¯ä»˜</button>
            <button class="cancel-btn">å–æ¶ˆæ”¯ä»˜</button>
        </div>
    `;

    // ç¡®è®¤æ”¯ä»˜å¤„ç†
    modal.querySelector('.confirm-btn').addEventListener('click', function() {
        const form = document.querySelector('form');
        if (form) form.submit();
        overlay.remove();
    });

    // å–æ¶ˆæ”¯ä»˜å¤„ç†
    modal.querySelector('.cancel-btn').addEventListener('click', function() {
        document.querySelectorAll('form').forEach(form => form.remove());
        overlay.remove();
    });

    // æ·»åŠ å¤åˆ¶åŠŸèƒ½
    modal.querySelector('.copyable').addEventListener('click', function() {
        const textToCopy = this.getAttribute('data-copy');
        navigator.clipboard.writeText(textToCopy).then(() => {
            alert('ä¹°å®¶è´¦å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
            console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬: ', err);
        });
    });

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

function obfuscateUserId(userId) {
    if (userId.length <= 4) {
      // å¦‚æœ userId çš„é•¿åº¦å°äºæˆ–ç­‰äº 4ï¼Œåˆ™æ— éœ€æ›¿æ¢ä»»ä½•å­—ç¬¦
      return userId;
    } else {
      // è·å–å‰ä¸¤ä½å’Œåä¸¤ä½
      const start = userId.slice(0, 2);
      const end = userId.slice(-2);
      // è®¡ç®—ä¸­é—´éƒ¨åˆ†åº”è¯¥è¢«æ›¿æ¢æˆå¤šå°‘ä¸ª *
      const middle = '*'.repeat(userId.length - 4);
      // è¿”å›æˆåŠŸæ›¿æ¢åçš„å­—ç¬¦ä¸²
      return `${start}${middle}${end}`;
    }
  }

document.addEventListener('DOMContentLoaded', function() {
    // æ ¹æ®æµ‹è¯•è¯‰æ±‚ï¼Œè®¾ç½®åŸºç¡€åœ°å€
    var sPayMallUrl = "http://117.72.115.188";
    var groupBuyMarketUrl = "http://117.72.115.188";
    var goodsId = "9890001";

    // è·å–ä¿¡æ¯
    var userId = getCookie("loginToken");
    if (!userId) {
        window.location.href = "login.html"; // è·³è½¬åˆ°ç™»å½•é¡µ
        return;
    }

    // è¯·æ±‚æ¥å£æ•°æ®
    fetch(groupBuyMarketUrl + '/api/v1/gbm/index/query_group_buy_market_config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            userId: userId,
            source: "s01",
            channel: "c01",
            goodsId: goodsId
        })
    })
    .then(response => response.json())
    .then(res => {
        if(res.code !== '0000') return;

        const { activityId, goods, teamList, teamStatistic } = res.data;
        const groupList = document.querySelector('.group-list');
        const promotionText = document.querySelector('.promotion-text');

        // æ›´æ–°ä¿ƒé”€ä¿¡æ¯
        promotionText.textContent = `ç›´é™ Â¥${goods.deductionPrice.toFixed(0)}ï¼Œ${teamStatistic.allTeamUserCount}äººå†æŠ¢ï¼Œå‚ä¸é©¬ä¸ŠæŠ¢åˆ°`;

        // æ¸…ç©ºå¹¶ç”Ÿæˆæ‹¼å›¢åˆ—è¡¨
        groupList.innerHTML = '';

        if (teamList.length === 0) {
            groupList.innerHTML = `
                <div class="group-item empty-tips">
                    <div class="tips-content">
                        å°ä¼™ä¼´ï¼Œèµ¶ç´§å»å¼€å›¢å§ï¼Œåšæ‘é‡Œæœ€é“çš„ä»”ï¼ğŸ‰
                    </div>
                </div>
            `;
        } else {
            teamList.forEach(team => {
                const remaining = team.targetCount - team.lockCount;

                groupList.innerHTML += `
                    <div class="group-item">
                        <div>
                            <div class="user-info" data-teamId="${team.teamId}" data-activityId="${team.activityId}">${obfuscateUserId(team.userId)}</div>
                            <div class="group-status">
                                <span>ç»„é˜Ÿä»…å‰©${remaining}äººï¼Œæ‹¼å•å³å°†ç»“æŸ</span>
                                <span class="countdown">${team.validTimeCountdown}</span>
                            </div>
                        </div>
                        <div class="right">
                            <button class="group-btn" data-price="${goods.payPrice.toFixed(0)}">å‚ä¸æ‹¼å›¢</button>
                        </div>
                    </div>
                `;
            });
        }

        // æ›´æ–°åº•éƒ¨æŒ‰é’®
        const buyAloneBtn = document.querySelector('.buy-alone');
        const groupBuyBtn = document.querySelector('.group-buy');
        buyAloneBtn.textContent = `å•ç‹¬è´­ä¹°(ï¿¥${goods.originalPrice.toFixed(0)})`;
        buyAloneBtn.dataset.price = goods.originalPrice;
        groupBuyBtn.textContent = `å¼€å›¢è´­ä¹°(ï¿¥${goods.payPrice.toFixed(0)})`;
        groupBuyBtn.dataset.price = goods.payPrice;

        // ç»‘å®šæ”¯ä»˜äº‹ä»¶[æ‹¼å›¢è´­ä¹°]
        document.querySelectorAll('.group-btn, .group-buy').forEach(btn => {
            btn.addEventListener('click', function() {
                const button = this;
                const price = button.dataset.price;

                // è·å–æ‹¼å›¢ID
                let teamId = null;
                if (this.classList.contains('group-btn')) {
                    const groupItem = this.closest('.group-item');
                    const userInfo = groupItem.querySelector('.user-info');
                    teamId = userInfo.dataset.teamid;
                }

                var url = sPayMallUrl + '/api/v1/alipay/create_pay_order';

                var requestBody = {
                     userId: userId,
                     productId: goods.goodsId,
                     teamId: teamId,
                     activityId: activityId,
                     marketType: 1
                };

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody) // å°†è¯·æ±‚ä½“è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                })
                .then(response => response.json()) // è§£æJSONæ ¼å¼çš„å“åº”
                .then(json => {
                    if (json.code === "0000") { // å‡è®¾æˆåŠŸçš„codeæ˜¯"0000"
                        document.querySelectorAll('form').forEach(form => form.remove());
                        document.body.insertAdjacentHTML('beforeend', json.data);
                        showPaymentConfirm(goods.payPrice);
                    } else {
                        console.error('Error:', json.info); // è¾“å‡ºé”™è¯¯ä¿¡æ¯
                    }
                })
                .catch(error => console.error('Error:', error));

            });
        });

        // ç»‘å®šæ”¯ä»˜äº‹ä»¶[å•ç‹¬è´­ä¹°]
        document.querySelectorAll('.buy-alone').forEach(btn => {
            btn.addEventListener('click', function() {
                const button = this;
                const price = button.dataset.price;

                var requestBody = {
                     userId: userId,
                     productId: goods.goodsId,
                     marketType: 0
                };

                fetch(sPayMallUrl + '/api/v1/alipay/create_pay_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody) // å°†è¯·æ±‚ä½“è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                })
                .then(response => response.json()) // è§£æJSONæ ¼å¼çš„å“åº”
                .then(json => {
                    if (json.code === "0000") { // å‡è®¾æˆåŠŸçš„codeæ˜¯"0000"
                        document.querySelectorAll('form').forEach(form => form.remove());
                        document.body.insertAdjacentHTML('beforeend', json.data);
                        showPaymentConfirm(goods.payPrice);
                    } else {
                        console.error('Error:', json.info); // è¾“å‡ºé”™è¯¯ä¿¡æ¯
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });

        // å¯åŠ¨å€’è®¡æ—¶
        document.querySelectorAll('.countdown').forEach(el => {
            new Countdown(el, el.textContent);
        });

    });

});
</script>

</body>
</html>